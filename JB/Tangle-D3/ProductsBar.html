<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>D3 Test</title>
    <script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
</head>
<style>
    .bar {
        fill: steelblue;
    }

    .bar:hover{
        fill: brown;
    }

</style>
<body>
<script type="text/javascript" src="HelpScript.js"></script>
<script type="text/javascript">
    var barPadding = 1;
    var low = 30;

    var margin = {top: 20, right: 20, bottom: 30, left: 40},
        width = 600 + margin.left,
        height = 1150 - margin.bottom,
        barPadding = 10,
        duration = 1000,
        head_height = 50;

    function INIT() {
        d3.csv("products.csv", function (prod) {
            d3.csv("data.csv", function (init_data){
                var products = prod.map(function (d) {
                    return d.product;
                });

                var initial_data = new Array(2*products.length + 1);

                for(var i = 0; i < initial_data.length; i++) {
                    initial_data[i] = [];
                }

                init_data.map(function (d) {
                    initial_data[0].push(d.amount);
                    initial_data[1].push(d.IDEA);
                    initial_data[2].push(d.RS);
                    initial_data[3].push(d.WS)
                    initial_data[4].push(d.FIRST)
                    initial_data[5].push(d.SECOND)
                    initial_data[6].push(d.THIRD)
                })

                var data = filter(mask, initial_data, products)

                var x = d3.scaleLinear().rangeRound([margin.left, width - margin.left]),
                    y = [];

                var l = 0;

                for (var i = 0; i < data.length; i++) {
                    if (i != 0) {
                        l += low;
                    }

                    y.push(d3.scaleBand().rangeRound([l + margin.top, (height - 500) / data.length + l + margin.top]).padding(0.1));
                    l += (height - 500) / data.length;
                }

                x.domain([0, d3.max(data, function (d) {
                    return d3.max(d);
                })]);

                for (var j = 0; j < data.length; j++) {
                    y[j].domain(data[j].map(function (d, i) {
                        return i;
                    }));
                }

                var head = d3.select("body").append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", head_height);

                var svg = d3.select("body").append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height);

                var g = svg.append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                var bar = g.selectAll(".bar");

                var rects = [],
                    text = [];

                for (var i = 0; i < data.length; i++) {
                    rects.push(bar.append("rect" + i)
                        .data(data[i])
                        .enter()
                        .append("rect"));

                    text.push(bar.append("text" + i)
                        .data(data[i])
                        .enter()
                        .append("text"));
                }

                function init() {
                    for (var j = 0; j < data.length; j++) {
                        rects[j]
                            .attr("class", "bar")
                            .attr("id", j)
                            .attr("x", margin.left)
                            .attr("y", function (d, i) {
                                return y[j](i);
                            })
                            .attr("width", function (d) {
                                return 0;
                            })
                            .attr("height", height / (data[j].length * 8) - barPadding)
                            .on("click", function (d, i, o) {
                                u = parseInt(o[i].id);

                                switch (u) {
                                    case 0:
                                        update_irp(i);
                                        break;
                                    case 1:
                                    case 2:
                                    case 3:
                                        update_fst(products[i], u + 2);
                                        break;
                                }

                                update();
                            })
                            .transition()
                            .duration(duration)
                            .attr("width", function (d) {
                                return x(d);
                            });

                        text[j]
                            .attr("x", margin.left)
                            .attr("y", function (d, i) {
                                return y[j](i) + (height / (data[j].length * 8))/2;
                            })
                            .text(0)
                            .attr("id", j)
                            .attr("font-family", "sans-serif")
                            .attr("font-size", "16px")
                            .attr("fill", "white")
                            .transition()
                            .duration(duration)
                            .attr("x", function(d) { return x(d) - textLength(d) * 11 + 1 + margin.left; })
                            .attrTween("text", function(d, i, o) {
                                var i = d3.interpolate(0, d),
                                    that = d3.select(this);

                                return function(t) {
                                    that.text(d3.format(",d")(i(t)));
                                };
                            })

                        bar.append("ProductText" + j)
                            .data(data[j])
                            .enter()
                            .append("text")
                            .attr("id", j)
                            .attr("x", function (d, i) {
                                switch (i) {
                                    case 0: return 0;
                                    case 1: return margin.left - 25;
                                    case 2: return margin.left - 27;
                                }
                            })
                            .attr("y", function (d, i) {
                                return y[j](i) + (height / (data[j].length * 8))/2;
                            })
                            .text(function (d, i) {
                                switch (i) {
                                    case 0: return products[0];
                                    case 1: return products[1];
                                    case 2: return products[2];
                                }
                            })
                            .attr("font-family", "sans-serif")
                            .attr("font-size", "16px")
                            .attr("fill", "black")

                        g
                            .append("text")
                            .attr("x", margin.left)
                            .attr("y", function () {
                                console.log(1)
                                return y[j](0) - 8;
                            })
                            .text(function () {
                                switch (j) {
                                    case 0: return "ALL";
                                    case 1: return "FIRST";
                                    case 2: return "SECOND";
                                    case 3: return "THIRD";
                                }
                            })
                            .attr("font-family", "sans-serif")
                            .attr("font-size", "25px")
                            .attr("fill", "green")
                    }
                }

                function update() {
                    var data = filter(mask, initial_data, products);

                    for (var j = 0; j < data.length; j++) {

                        rects[j]
                            .transition()
                            .duration(duration)
                            .attr("width", function (d, i) {
                                return x(data[j][i]);
                            });

                        text[j]
                            .transition()
                            .duration(duration)
                            .attr("x", function (d, i) {
                                return x(data[j][i]) - textLength(data[j][i]) * 11 + 1 + margin.left;
                            })
                            .attrTween("text", function(d, i, o) {
                                var that = d3.select(this),
                                    id = parseInt(o[i].id),
                                    dd = o[i].__data__,
                                    k = d3.interpolate(dd, data[id][i]);

                                o[i].__data__ = data[id][i];

                                return function(t) {
                                    that.text(d3.format(",d")(k(t)));
                                };
                            })
                    }
                }

                init();
            })
        })
    }

    INIT()

</script>
</body>
</html>